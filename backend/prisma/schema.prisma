// JewTable Backend - Prisma Schema
// PostgreSQL database schema with multi-tenancy support

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== Core Tables ====================

model Organization {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users         User[]
  employees     Employee[]
  departments   Department[]
  statuses      Status[]
  tableSettings TableSettings[]
  auditLogs     AuditLog[]

  @@map("organizations")
}

model User {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  email          String   @unique
  passwordHash   String   @map("password_hash")
  name           String
  role           String   @default("user")
  active         Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization     Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  tableSettings    TableSettings[]
  createdEmployees Employee[]      @relation("EmployeeCreatedBy")
  updatedEmployees Employee[]      @relation("EmployeeUpdatedBy")
  auditLogs        AuditLog[]

  @@index([organizationId])
  @@index([email])
  @@map("users")
}

// ==================== Main Data Table (Example: Employees) ====================

model Employee {
  id             String    @id @default(uuid())
  organizationId String    @map("organization_id")
  name           String
  position       String?
  departmentId   String?   @map("department_id")
  salary         Decimal?  @db.Decimal(10, 2)
  commission     Decimal?  @db.Decimal(5, 4)
  startDate      DateTime? @map("start_date") @db.Date
  active         Boolean   @default(true)
  statusId       String?   @map("status_id")
  performance    Int?      @db.SmallInt
  sortOrder      Int       @default(0) @map("sort_order") // For row reordering
  version        Int       @default(1) // For optimistic locking
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  createdBy      String?   @map("created_by")
  updatedBy      String?   @map("updated_by")

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department   Department?   @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  status       Status?       @relation(fields: [statusId], references: [id], onDelete: SetNull)
  creator      User?         @relation("EmployeeCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  updater      User?         @relation("EmployeeUpdatedBy", fields: [updatedBy], references: [id], onDelete: SetNull)
  managedDepts Department[]  @relation("DepartmentManager")

  @@index([organizationId, departmentId])
  @@index([organizationId, active])
  @@index([statusId])
  @@index([name])
  @@map("employees")
}

// ==================== Reference Data Tables ====================

model Department {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  name           String
  code           String?
  managerId      String?  @map("manager_id")
  budget         Decimal? @db.Decimal(12, 2)
  active         Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  manager      Employee?    @relation("DepartmentManager", fields: [managerId], references: [id], onDelete: SetNull)
  employees    Employee[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([managerId])
  @@map("departments")
}

model Status {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  label          String
  variant        String?  // success, warning, danger, info, etc.
  icon           String?
  color          String?
  active         Boolean  @default(true)
  sortOrder      Int      @default(0) @map("sort_order")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  employees    Employee[]

  @@index([organizationId])
  @@index([active])
  @@map("statuses")
}

// ==================== User Preferences & Settings ====================

model TableSettings {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  organizationId String   @map("organization_id")
  tableId        String   @map("table_id")
  settings       Json     // Stores filters, sorting, column visibility, widths, etc.
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, tableId])
  @@index([userId])
  @@index([organizationId])
  @@map("table_settings")
}

// ==================== Audit Log ====================

model AuditLog {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  userId         String?  @map("user_id")
  tableName      String   @map("table_name")
  recordId       String?  @map("record_id")
  action         String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc.
  changes        Json?    // Before/after values
  ipAddress      String?  @map("ip_address")
  userAgent      String?  @map("user_agent")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([userId])
  @@index([tableName, recordId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ==================== Session Management (Optional) ====================

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}
